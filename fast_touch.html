<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<title>Comic Book Reader</title>
		<script src="js/jquery-1.11.3.min.js"></script>
		<script src="js/polyfill/polyfill.js"></script>
	</head>
	<style>
		html {
			box-sizing: border-box;
			min-height: 100%;
			height: 100%;
			font-family: Helvetica, Arial, sans-serif;
			color: white;
		}
		body {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
			overflow: hidden;
			min-height: 100%;
		}
		#comicPanel {
			box-sizing: border-box;
			overflow: hidden;
			overflow-x: scroll;
			position: absolute;
			top: 0;
			bottom: 0;
			right: 0;
			left: 0;
		}
		#comicPanel img {
			pointer-events: none;
			width: 100%;
			height: auto;
		}
		#horizontalScroller {
			box-sizing: border-box;
			display: flex;
			flex-direction: row;
			flex-wrap: nowrap;
			justify-content: flex-start;
			align-items: stretch;
			height: 100%;
		}
		.verticalScroller {
			box-sizing: border-box;
			overflow: hidden;
			overflow-y: scroll;
			border: 1px solid blue;
			flex: none;
			width: 100%;
		}
	</style>
	<body>
		<div id="comicPanel">
			<div id="horizontalScroller">
			</div>
		</div>

		<script type="text/javascript">
			var g_is_mouse_down = false;
			var g_has_scrolled = false;
//			var g_ignore_scroll_event = false;
			var g_screen_width = 0;
			var g_titles = {};
			var g_titles_small = {};
			for (var i=0; i<200; ++i) {
				g_titles[i] = "comic/" + (i + 1) + ".jpg";
				g_titles_small[i] = "comic/small/small-" + (i + 1) + ".jpg";
			}
			var g_image_index = 0;
			var g_image_count = Object.keys(g_titles).length;
			var g_is_busy_loading = false;

			function onResize() {
				g_screen_width = window.innerWidth;
				//console.info(g_screen_width);

				// FIXME: We should not have to set this every time the screen
				// size changes.
				var cells = document.querySelectorAll('.verticalScroller');
				for (var i=0; i<cells.length; ++i) {
					cells[i].style.flexBasis = g_screen_width + 'px';
				}

				document.querySelector('#comicPanel').scrollLeft = 0;
			}

			function loadImage(page, index, cb) {
				page.innerHTML = '';

				var url = g_titles_small[index];
				console.info('    ' + url);
				var img = document.createElement('img');
				img.src_high = g_titles[index];
				img.src_low = g_titles_small[index];
				img.id = 'page_' + index;
				img.title = "FIXME";
				img.className = 'comicPage';
				img.ondragstart = function() { return false; }
				img.onload = function() {
					img.onload = null;
					img.onerror = null;

					cb(index);
				};
				img.onerror = function() {
					img.onload = null;
					img.onerror = null;

					img.title = '';
					img.alt = 'Invalid Image';
					img.src = 'invalid_image.png';
					cb(index);
				};
				img.draggable = 'false';
				if (index < 2) {
					img.src = img.src_high;
				} else {
					img.src = img.src_low;
				}
				page.appendChild(img);
			}

			function monitorImageQualitySwapping() {
				var comic_panel = document.querySelector('#comicPanel');
				var old_left = comic_panel.scrollLeft;

				setInterval(function() {
					var new_left = comic_panel.scrollLeft;

					//console.info((! g_is_busy_loading) + ', ' + g_has_scrolled + ', ' + (! g_is_mouse_down) + ', ' + old_left + ', ' + new_left);
					if (! g_is_busy_loading && g_has_scrolled && ! g_is_mouse_down && old_left === new_left) {
						g_has_scrolled = false;

						//console.info('reset scroll ....................' + scroll_left);
						var new_page = Math.round(new_left / g_screen_width);
						new_left = new_page * g_screen_width;
						//console.info(new_page + ', ' + new_left);
						$('#comicPanel').animate({scrollLeft: new_left}, 300);

						setTimeout(function() {
							g_is_busy_loading = true;
							console.info(g_image_index + ', ' + new_page);

							// Get all the images to swap out the quality
							var imagesToSwap = [];
							for (var i=0; i<g_image_count; ++i) {
								var page = document.querySelector('#page_' + i);
								if (i === new_page-1 || i === new_page || i === new_page+1) {
									if (! page.src.endsWith(page.src_high)) {
										imagesToSwap.push({page: page, src: page.src_high});
									}
								} else {
									if (! page.src.endsWith(page.src_low)) {
										imagesToSwap.push({page: page, src: page.src_low});
									}
								}
							}

							// Swap out the images in serial
							var loadNextPage = function(i) {
								if (i >= imagesToSwap.length) {
									g_is_busy_loading = false;
									return;
								}

								var item = imagesToSwap[i];
								var page = item.page;
								var src = item.src;

								page.onload = function() {
									this.onload = null;
									this.onerror = null;
									console.info(this.src);
									document.title = this.src;
									loadNextPage(i + 1);
								};
								page.onerror = function() {
									this.onload = null;
									this.onerror = null;
									this.title = '';
									this.alt = 'Invalid Image';
									this.src = 'invalid_image.png';
									console.info(this.src);
									document.title = this.src;
									loadNextPage(i + 1);
								};
								page.src = src;
							};
							loadNextPage(0);
							g_image_index = new_page;
						}, 300);
					}

					old_left = new_left;
				}, 100);
			}

			function onScroll(e) {
				g_has_scrolled = true;
/*
				if (g_ignore_scroll_event) {
					g_ignore_scroll_event = false;
					return;
				}

				if (! g_is_mouse_down) {
					var comic_panel = document.querySelector('#comicPanel');
					var scroll_left = comic_panel.scrollLeft;
					var new_offset = Math.round(scroll_left / g_screen_width) * g_screen_width;
					console.info(new_offset);
					g_ignore_scroll_event = true;
					comic_panel.scrollLeft = new_offset;
				}
*/
			}

			function onMouseDown(e) {
				g_is_mouse_down = true;
			}

			function onMouseUp(e) {
				g_is_mouse_down = false;
			}

			function onTouchStart(e) {
				g_is_mouse_down = true;
			}

			function onTouchEnd(e) {
				g_is_mouse_down = false;
			}

			document.querySelector('#comicPanel').scrollLeft = 0;
			window.onresize = onResize;

			var comic_panel = document.querySelector('#comicPanel');
			comic_panel.addEventListener('mousedown', onMouseDown, false);
			comic_panel.addEventListener('mouseup', onMouseUp, false);
			comic_panel.addEventListener('mouseleave', onMouseUp, false);
			comic_panel.addEventListener('scroll', onScroll, false);

			comic_panel.addEventListener('touchstart', onTouchStart, false);
			comic_panel.addEventListener('touchend', onTouchEnd, false);
			//comic_panel.addEventListener('touchcancel', ignoreEvent, false);

			//onResize();
			g_screen_width = window.innerWidth;

			var container = document.querySelector('#horizontalScroller');

			var loadNextPage = function(i) {
				console.info('loadNextPage: ' + i);
				document.title = i;
				if (i >= g_image_count) {
					return;
				}

				var page = document.createElement('div');
				page.className = 'verticalScroller';
				page.style.flexBasis = g_screen_width + 'px';
				container.appendChild(page);
				loadImage(page, i, function() {
					loadNextPage(i + 1);
				});
			};
			loadNextPage(0);
			monitorImageQualitySwapping();
		</script>
	</body>
</html>
