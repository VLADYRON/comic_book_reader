<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<title>Comic Book Reader</title>
		<script src="js/jquery-1.11.3.min.js"></script>
	</head>
	<style>
		html {
			box-sizing: border-box;
			min-height: 100%;
			height: 100%;
			font-family: Helvetica, Arial, sans-serif;
			color: white;
		}
		body {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
			overflow: hidden;
			min-height: 100%;
		}
		#comicPanel {
			overflow: hidden;
			overflow-x: scroll;
			position: absolute;
			top: 0;
			bottom: 0;
			right: 0;
			left: 0;
		}
		#comicPanel img {
			pointer-events: none;
			width: 100%;
			height: auto;
		}
		.horizontalScroller {
			display: flex;
			flex-direction: row;
			flex-wrap: nowrap;
			justify-content: flex-start;
			align-items: stretch;
			height: 100%;
			width: 200%;
		}
		.verticalScroller {
			overflow: hidden;
			overflow-y: scroll;
			border: 1px solid blue;
		}
	</style>
	<body>
		<div id="comicPanel">
			<div class="horizontalScroller">
				<div id="pageLeft" class="verticalScroller">
				</div>
				<div id="pageMiddle" class="verticalScroller">
				</div>
				<div id="pageRight" class="verticalScroller">
				</div>
			</div>
		</div>

		<script type="text/javascript">
			var g_is_mouse_down = false;
			var g_screen_width = 0;
			var g_image_index = 0;
			var g_image_count = 6;
			var g_titles = {
				0: "comic/page 001.png",
				1: "comic/page 002.png",
				2: "comic/page 003.png",
				3: "comic/page 004.png",
				4: "comic/page 005.png",
				5: "comic/page 006.png"
			};

			function onResize() {
				g_screen_width = window.innerWidth;
				//console.info(g_screen_width);

				var cells = document.querySelectorAll('.verticalScroller');
				for (var i=0; i<cells.length; ++i) {
					cells[i].style.flexBasis = g_screen_width + 'px';
					//console.info(cells[i].style.flexBasis);
				}

				var style = document.querySelector('.horizontalScroller').style;
				style.width = (g_screen_width * cells.length) + 'px';

				document.querySelector('#comicPanel').scrollLeft = 0;//g_screen_width;
			}

			function loadImage(container, index) {
				container.empty();

				var url = g_titles[index];
				console.info('    ' + url);
				var img = document.createElement('img');
				img.id = 'page_' + index;
				img.title = "FIXME";
				img.className = 'comicPage';
				img.ondragstart = function() { return false; }
				img.onload = function() {

				};
				img.onerror = function() {
					img.onload = null;
					img.onerror = null;

					img.title = '';
					img.alt = 'Invalid Image';
					img.src = 'invalid_image.png';
				};
				img.draggable = 'false';
				img.src = url;
				container.append(img);
			}
/*
			var g_skip_scroll = false;

			function onScrollReset(scroll_left) {
				console.info('!!! onScrollReset: ' + g_skip_scroll);
				g_skip_scroll = true;
				//var old_page = Math.round(scroll_left / g_screen_width);
				var new_offset = Math.round(scroll_left / g_screen_width) * g_screen_width;
//							console.info(new_offset);
				//comicPanel.scrollLeft = page * g_screen_width;
				$('#comicPanel').animate({scrollLeft: new_offset}, 300);

				setTimeout(function() {
					var comicPanel = document.querySelector('#comicPanel');
					scroll_left = comicPanel.scrollLeft;
					g_image_index = Math.floor(scroll_left / g_screen_width);
					console.info('reset scroll ....................' + g_image_index);

					//comicPanel.scrollLeft = (g_image_index-1) * g_screen_width;
					console.info('reset scroll ....................' + scroll_left);
					if (scroll_left === 0) {
						comicPanel.scrollLeft = 0;
					} else if (scroll_left === (g_screen_width * 2)) {
						comicPanel.scrollLeft = (g_screen_width * 1);
					}

					//g_image_index += 1;
					loadImage($('#pageLeft'), g_image_index-1);
					loadImage($('#pageMiddle'), g_image_index);
					loadImage($('#pageRight'), g_image_index+1);
					g_skip_scroll = false;
				}, 300);
			}
*/
			var g_ignore_scroll_event = false;
			var g_ignore_scroll_animation = false;
			var g_page = 0;

			function shit() {
				var comicPanel = document.querySelector('#comicPanel');
				var old_left = comicPanel.scrollLeft;

				setInterval(function() {
					var new_left = comicPanel.scrollLeft;
//					console.info('fuuuu ' + old_left + ', ' + new_left + ', ' + g_is_mouse_down);

					var is_centered_on_page = (new_left % g_screen_width) === 0;

					if (old_left === new_left && ! is_centered_on_page && ! g_is_mouse_down) {
//						console.info('Done scrolling ??????????');

						//console.info('reset scroll ....................' + scroll_left);
						var new_offset = Math.round(new_left / g_screen_width) * g_screen_width;
						g_ignore_scroll_animation = true;
						//comicPanel.scrollLeft = new_offset;
						$('#comicPanel').animate({scrollLeft: new_offset}, 300);
						setTimeout(function() {
							g_ignore_scroll_animation = false;

							var new_page = Math.floor(new_offset / g_screen_width);
							console.info('g_page: ' + g_page + ', new_page: ' + new_page);

							// Move middle to left
							if (g_page === 1 && new_page === 0) {
								console.info('!!! move middle to left');
								if (g_image_index > 1) {
									g_image_index--;
									g_page = 1;
									comicPanel.scrollLeft = (g_screen_width * g_page);
								}
							// Move middle right
							} else if (g_page === 1 && new_page === 2) {
								console.info('!!! move middle to right');
								if ((g_image_index+2) < g_image_count) {
									g_image_index++;
									g_page = 1;
									comicPanel.scrollLeft = (g_screen_width * g_page);
								}
							// Move left to middle
							} else if (g_page === 0 && new_page === 1) {
								console.info('!!! move left to middle');
								g_image_index++;
								//comicPanel.scrollLeft = (g_screen_width * g_page);
								g_page = 1;
							// Move right to middle
							} else if (g_page === 2 && new_page === 1) {
								console.info('!!! move right to middle');
								g_image_index--;
								//comicPanel.scrollLeft = (g_screen_width * g_page);
								g_page = 1;
							}

							loadImage($('#pageLeft'), g_image_index-1);
							loadImage($('#pageMiddle'), g_image_index);
							loadImage($('#pageRight'), g_image_index+1);

							//g_page = new_page;
							console.info('g_page: ' + g_page + ', new_page: ' + new_page);
						}, 400);
					}

					old_left = new_left;
				}, 1000);
			}

			function onScroll(e) {
/*
				if (g_ignore_scroll_animation) {
					return;
				}
				if (g_ignore_scroll_event) {
					g_ignore_scroll_event = false;
					return;
				}

				console.info('onScroll');
				var comicPanel = document.querySelector('#comicPanel');
				var scroll_left = comicPanel.scrollLeft;

				//console.info('reset scroll ....................' + scroll_left);
				if (scroll_left === 0) {
					g_image_index = Math.floor(scroll_left / g_screen_width);
					console.info('g_image_index: ' + g_image_index);
					loadImage($('#pageLeft'), g_image_index-1);
					loadImage($('#pageMiddle'), g_image_index);
					loadImage($('#pageRight'), g_image_index+1);
				} else if (scroll_left === (g_screen_width * 2)) {
					g_image_index = Math.floor(scroll_left / g_screen_width);
					console.info('g_image_index: ' + g_image_index);
					loadImage($('#pageLeft'), g_image_index-1);
					loadImage($('#pageMiddle'), g_image_index);
					loadImage($('#pageRight'), g_image_index+1);
				}
*/
			}

			function onMouseDown(e) {
				g_is_mouse_down = true;
			}

			function onMouseUp(e) {
				g_is_mouse_down = false;
			}

			function onTouchStart(e) {
				g_is_mouse_down = true;
			}

			function onTouchEnd(e) {
				g_is_mouse_down = false;
			}

			window.onresize = onResize;

			onResize();

			var comicPanel = document.querySelector('#comicPanel');
			comicPanel.addEventListener('mousedown', onMouseDown, false);
			comicPanel.addEventListener('mouseup', onMouseUp, false);
			comicPanel.addEventListener('mouseleave', onMouseUp, false);
			comicPanel.addEventListener('scroll', onScroll, false);

			comicPanel.addEventListener('touchstart', onTouchStart, false);
			comicPanel.addEventListener('touchend', onTouchEnd, false);
			//comicPanel.addEventListener('touchcancel', ignoreEvent, false);

			loadImage($('#pageLeft'), 0);
			loadImage($('#pageMiddle'), 1);
			loadImage($('#pageRight'), 2);
			shit();
		</script>
	</body>
</html>
