<!DOCTYPE html>

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>Comic Book Reader</title>
		<style>
#mainPanel {
	padding: 0;
	margin: 0;
	background: rgba(0, 0, 0, 0.0);
	height: 100%;
	width: 100%;
	text-align: center;
	font: 100px/300px Helvetica, Arial, sans-serif;
	text-shadow: 4px 4px 20px white;
	opacity: 0.5;
	position: fixed;
}

#topPanel {
	opacity: 0.9;
	border: 1px solid black;
	margin: 20px;
	margin-top: 0px;
	padding: 20px;
	padding-top: 0px;
	box-shadow: 10px 10px 5px #888888;
	background: silver;
	text-align: center;
}

#loadProgress {
	width: 100%;
	display: none;
}

#btnFullScreen {
	font: 30px/100px Helvetica, Arial, sans-serif;
}

#fileInput {
	display: none;
}

#fileLoad {
	font: 30px/100px Helvetica, Arial, sans-serif;
}

.fuck {
	pointer-events: none;
	width: 100%;
	user-select: none;
	-moz-user-select: none;
	-webkit-user-select: none;
}

/*
#pageHolder {
	pointer-events: none;
	width: 100%;
	position: absolute;
	top: 0;
	left: 0;
	z-index: -100;
}
*/
		</style>
		<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
		<script src="js/polyfill/polyfill.js"></script>
<!--
		<script src="https://hammerjs.github.io/dist/hammer.js"></script>
-->
		<script src="js/zip.js"></script>
		<script src="js/screenfull.js/screenfull.js"></script>
	</head>
	<body style="margin: 0; padding: 0;">
		<div id="topPanel">
			<input id="fileInput" type="file" required="required" />
			<button id="fileLoad">Load comic from your computer</button>

			<button id="btnFullScreen">Full Screen</button>

			<progress id="loadProgress" max="1" value="0"></progress>
			<p><span id="loadError"></span></p>
			<div id="comicData">
				<b>Name:</b> <span id="nameValue"></span><br>
				<b>Size:</b> <span id="sizeValue"></span><br>
				<b>Type:</b> <span id="typeValue"></span><br>
			</div>
		</div>

		<div id="mainPanel"></div>

		<div id="imageHolder" style="border: 10px solid orange; overflow: hidden;">
			<div id="draggableContainer" style="border: 10px solid black; overflow: hidden;">
				<div id="draggableLeft" style="position: absolute; z-index: 0px; opacity: 0.5; text-align: center; background-color: red;">
					Left Page
				</div>
				<div id="draggableMiddle" style="position: absolute; z-index: 0px; opacity: 0.5; text-align: center; background-color: green;">
					Middle Page
				</div>
				<div id="draggableRight" style="position: absolute; z-index: 0px; opacity: 0.5; text-align: center; background-color: blue;">
					Right Page
				</div>
			</div>
		</div>

		<script>

var g_entries = [];
var g_images = [];
var g_image_index = 0;
var g_is_mouse_down = false;
var g_mouse_start_x = 0;
var g_screen_width = 0;
var g_is_swiping_right = false;
var g_is_swiping_left = false;
var g_left = null;
var g_middle = null;
var g_right = null;

function toFrieldlySize(size) {
	if (size >= 1024000000) {
		return (size / 1024000000).toFixed(2) + ' GB';
	} else if (size >= 1024000) {
		return (size / 1024000).toFixed(2) + ' MB';
	} else if (size >= 1024) {
		return (size / 1024).toFixed(2) + ' KB';
	} else if (size >= 1) {
		return (size / 1).toFixed(2) + ' B';
	}

	return '?';
}

function blobToDataURI(blob, cb) {
	var reader = new FileReader();
	reader.onload = function(e) {
		cb(e.target.result);
	};
	reader.readAsDataURL(blob);
}

function isValidImageType(file_name) {
	file_name = file_name.toLowerCase();
	return file_name.endsWith('.jpeg') || 
			file_name.endsWith('.jpg') ||
			file_name.endsWith('.png') || 
			file_name.endsWith('.bmp');
}

function loadComic() {
	var file_input = $('#fileInput');

	// Just return if there is no file selected
	if (file_input[0].files.length === 0) {
		return;
	}

	// Load the file's info
	clearComicData();
	var file = file_input[0].files[0];
	setComicData(file.name, file.size, file.type);

	// Read the file
	onProgress(1, 1);
	$('#loadProgress').hide();
	$('#topPanel').hide();
	$('#mainPanel').show();

	var blob = file.slice();
	onLoaded(blob);
}

function friendlyPageNumber() {
	return 'Page ' + (g_image_index + 1) + ' of ' + g_images.length;
}

function loadCurrentPage() {
	// Load the current page
	updatePageCache(g_image_index);
	g_middle.empty();
	g_middle.append(g_images[g_image_index]);
	$('#mainPanel')[0].textContent = friendlyPageNumber();

	// Load next page
	if (g_image_index < g_images.length -1) {
		g_right.empty();
		g_right.append(g_images[g_image_index + 1]);
	}

	// Load previous page
	if (g_image_index > 0) {
		g_left.empty();
		g_left.append(g_images[g_image_index - 1]);
	}

	// Cache the next image
	delayedUpdateNextPageCache(g_image_index, 2);

	// Cache the previous image
	delayedUpdatePreviousPageCache(g_image_index, 2);
}

function delayedUpdateNextPageCache(index, depth) {
	if (index < g_images.length - 1) {
		index++;
		setTimeout(function() {
			if (depth > 0) {
				depth--;
				delayedUpdateNextPageCache(index, depth);
			}
			updatePageCache(index);
		}, 333);
	}
}

function delayedUpdatePreviousPageCache(index, depth) {
	if (index > 0) {
		index--;
		setTimeout(function() {
			if (depth > 0) {
				depth--;
				delayedUpdatePreviousPageCache(index, depth);
			}
			updatePageCache(index);
		}, 333);
	}
}

function updatePageCache(index) {
	var img = g_images[index];
	if (img.is_loaded) {
		console.info('!!! Cached page: ' + index + ', ' + img.title);
	} else {
		var entry = g_entries[index];
		entry.getData(new zip.BlobWriter(), function(blob) {
	//		console.info(entry.filename);
	//		console.info(blob);
			blobToDataURI(blob, function(data_uri) {
				// Load the blob into an image
				var img = g_images[entry.index];
				img.src = data_uri;
				img.is_loaded = true;
				console.info('Loaded page: ' + index + ', ' + img.title);
			});
		});
	}
}

function setComicData(name, size, type) {
	$('#comicData').show();
	$('#nameValue').text(name);
	$('#sizeValue').text(toFrieldlySize(size));
	$('#typeValue').text(type);
}

function clearComicData() {
	// Reset the UI
	$('#loadError').hide();
	$('#comicData').hide();
	$('#loadProgress').val(0);
	setComicData('?', '?', '?');

	// Remove all the old images and compressed file entries
	g_middle.empty();
	g_left.empty();
	g_right.empty();
	g_image_index = 0;
	g_images = [];
	g_entries = [];
}

function onLoaded(blob) {
	var reader = new zip.BlobReader(blob);
	zip.createReader(reader, function(reader) {
		reader.getEntries(function(entries) {
			// Get only the entries that are valid images
			g_entries = [];
			entries.forEach(function(entry) {
				if (! entry.directory && isValidImageType(entry.filename)) {
					g_entries.push(entry);
				}
			});

			// Sort the entries by their file names
			g_entries.sort(function(a, b){
				if(a.filename < b.filename) return -1;
				if(a.filename > b.filename) return 1;
				return 0;
			});

			// Create empty images for each page
			var i = 0;
			g_entries.forEach(function(entry) {
				var img = document.createElement('img');
				img.title = entry.filename;
				img.className = 'fuck';
				g_images.push(img);
				entry.index = i;
				i++;
			});

			g_image_index = 0;
			loadCurrentPage();
			var width = $(window).width();
			onResize(width);
		});
	}, function(e) {
		onError('Failed to read file!');
	});
}

function onError(msg) {
	$('#mainPanel').hide();
	$('#comicData').hide();
	$('#loadError').text('Error: ' + msg);
	$('#loadError').show();
	$('#topPanel').show();
}

function onProgress(loaded, total) {
	$('#loadProgress').show();
	$('#loadProgress').val(loaded / total);
}

function onResize(screen_width) {
	g_screen_width = screen_width;
	$('#imageHolder')[0].style.width = (g_screen_width * 3) + 'px';

	var style = $('#draggableContainer')[0].style;
	style.width = (g_screen_width * 3) + 'px';
	style.height = '200px';
	style.transitionDuration = '0.0s';
//	style.transform = 'translate3d(-' + g_screen_width + 'px, 0px, 0px)';

	style = g_left[0].style;
	style.width = g_screen_width + 'px';
	style.height = '200px';
	style.transitionDuration = '0.0s';
	g_left[0].translatedX = 0;
	style.transform = 'translate3d(' + g_left[0].translatedX + 'px, 0px, 0px)';

	style = g_middle[0].style;
	style.width = g_screen_width + 'px';
	style.height = '200px';
	style.transitionDuration = '0.0s';
	g_middle[0].translatedX = g_screen_width * 1;
	style.transform = 'translate3d(' + g_middle[0].translatedX + 'px, 0px, 0px)';

	style = g_right[0].style;
	style.width = g_screen_width + 'px';
	style.height = '200px';
	style.transitionDuration = '0.0s';
	g_right[0].translatedX = g_screen_width * 2;
	style.transform = 'translate3d(' + g_right[0].translatedX + 'px, 0px, 0px)';
}

$(document).ready(function() {
	// Tell zip.js where it can find the worker js file
	zip.workerScriptsPath = 'js/';

	g_left = $('#draggableLeft');
	g_middle = $('#draggableMiddle');
	g_right = $('#draggableRight');
	var width = 200; // FIXME: Debug initial size
	onResize(width);
/*
	// Stop the right click menu from popping up
	$(document).on('contextmenu', function(e) {
		e.preventDefault();
	});
*/
	// Toggle full screen
	$('#btnFullScreen').click(function () {
		if (screenfull.enabled) {
			screenfull.toggle();
		}
	});
/*
	// Tell Hammer to use the main pannel
	$('#mainPanel').hide();
	var mc = new Hammer($('#mainPanel')[0]);

	// Have gestures work in all directions
	mc.get('pan').set({ direction: Hammer.DIRECTION_ALL });

	// Show the file load menu when panning down
	mc.on('pandown', function(ev) {
		$('#topPanel').show();
	});

	// Hide the file load menu when panning up
	mc.on('panup', function(ev) {
		$('#topPanel').hide();
	});

	// Show the next page when panning left
	mc.on('panleft tap', function(ev) {
		if ($('#topPanel').is(':visible')) {
			$('#topPanel').hide();
		} else {
			if (g_image_index < g_images.length -1) {
				g_image_index++;
				loadCurrentPage();
			}
		}
	});

	// Show the previous page when panning right
	mc.on('panright press', function(ev) {
		if ($('#topPanel').is(':visible')) {
			$('#topPanel').hide();
		} else {
			if (g_image_index > 0) {
				g_image_index--;
				loadCurrentPage();
			}
		}
	});
*/

	var g_moving_pannel = null;

	g_left.mousedown(function(e) {
		g_moving_pannel = g_left;
	});

	g_middle.mousedown(function(e) {
		g_moving_pannel = g_middle;
	});

	g_right.mousedown(function(e) {
		g_moving_pannel = g_right;
	});

	$('#draggableContainer').mousedown(function(e) {
		g_is_mouse_down = true;
		g_mouse_start_x = e.clientX;
		console.info(g_mouse_start_x);
	});

	$(window).resize(function(e) {
		var width = $(window).width();
		onResize(width);
	});

	$('#draggableContainer').on('mouseup mouseleave', function(e) {
		console.info('mouse up ' + g_is_mouse_down);
		if (! g_is_mouse_down) {
			return;
		}
		g_is_mouse_down = false;
		g_moving_pannel = null;
/*
		

		if (g_is_swiping_right) {
			g_is_swiping_right = false;
			if (g_image_index > 0) {
				g_image_index--;
				loadCurrentPage();
			}
		} else if (g_is_swiping_left) {
			g_is_swiping_left = false;

			var style = g_right[0].style;
			style.transitionDuration = '0.3s';
			style.transform = 'translate3d(-' + (g_screen_width) + 'px, 0px, 0px)';

			style = g_middle[0].style;
			style.transitionDuration = '0.3s';
			style.transform = 'translate3d(-' + g_screen_width + 'px, 0px, 0px)';

			// Update the page orderings, after the pages move into position
			setTimeout(function() {
				console.info('herp ............................');
				var old_left = g_left;
				var old_middle = g_middle;
				var old_right = g_right;
				g_left = old_middle;
				g_middle = old_right;
				g_right = old_left;

				var style = g_left[0].style;
				style.transitionDuration = '0.3s';
				style.transform = 'translate3d(-' + (g_screen_width) + 'px, 0px, 0px)';

				style = g_middle[0].style;
				style.transitionDuration = '0.3s';
				style.transform = 'translate3d(0px, 0px, 0px)';

				style = g_right[0].style;
				style.transitionDuration = '0.3s';
				style.transform = 'translate3d(' + (g_screen_width * 2) + 'px, 0px, 0px)';
			}, 5000);
//			if (g_image_index < g_images.length -1) {
//				g_image_index++;
//				loadCurrentPage();
//			}
		} else {
			var style = g_left[0].style;
			style.transitionDuration = '0.3s';
			style.transform = 'translate3d(0px, 0px, 0px)';

			style = g_middle[0].style;
			style.transitionDuration = '0.3s';
			style.transform = 'translate3d(' + (g_screen_width * 1) + 'px, 0px, 0px)';

			style = g_right[0].style;
			style.transitionDuration = '0.3s';
			style.transform = 'translate3d(' + (g_screen_width * 2) + 'px, 0px, 0px)';
		}
*/
	});

	$('#draggableContainer').mousemove(function(e) {
		if (! g_is_mouse_down) {
			return;
		}

		var x_offset = e.clientX - g_mouse_start_x;
		var x = g_moving_pannel[0].translatedX + x_offset;
		console.info('screen:'+e.clientX + ', start:'+g_mouse_start_x + ', x:'+x);
		var style = g_moving_pannel[0].style;
		style.transitionDuration = '0.0s';
		style.transform = 'translate3d(' + x + 'px, 0px, 0px)';

		if (x_offset > 0) {
/*
			if (Math.abs(x) > g_screen_width / 2) {
//				console.info(Math.abs(x) + ' > ' + (g_screen_width / 2));
				g_is_swiping_right = true;
			} else {
				g_is_swiping_right = false;
				g_is_swiping_left = false;
			}
*/
		} else {
			// FIXME: if moving left, move the g_right pannel left
/*
			if (Math.abs(x) > g_screen_width / 2) {
				console.info(Math.abs(x) + ' > ' + (g_screen_width / 2));
				g_is_swiping_left = true;
			} else {
				g_is_swiping_right = false;
				g_is_swiping_left = false;
			}
		}
*/
	});

	$('#mainPanel').hide();

	// When a file is selected, load it
	$('#fileInput').change(function(e) {
		loadComic();
	});

	// When the button is clicked, click the hidden file load button
	$('#fileLoad').click(function(e) {
		$('#fileInput').click();
	});
	clearComicData();
});
		</script>
	</body>

</html>
